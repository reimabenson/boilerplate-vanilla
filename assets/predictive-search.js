"use strict";class PredictiveSearch extends SearchForm{constructor(){super();this.cachedResults={};this.predictiveSearchResults=this.querySelector("[data-predictive-search]");this.allPredictiveSearchInstances=document.querySelectorAll("predictive-search");this.isOpen=false;this.abortController=new AbortController;this.searchTerm="";this.setupEventListeners()}setupEventListeners(){this.input.form.addEventListener("submit",this.onFormSubmit.bind(this));this.input.addEventListener("focus",this.onFocus.bind(this));this.addEventListener("focusout",this.onFocusOut.bind(this));this.addEventListener("keyup",this.onKeyup.bind(this));this.addEventListener("keydown",this.onKeydown.bind(this))}getQuery(){return this.input.value.trim()}onChange(){var e;super.onChange();const t=this.getQuery();if(!this.searchTerm||!t.startsWith(this.searchTerm))(e=this.querySelector("#predictive-search-results-groups-wrapper"))==null?void 0:e.remove();this.updateSearchForTerm(this.searchTerm,t);this.searchTerm=t;if(!this.searchTerm.length){this.close(true);return}this.getSearchResults(this.searchTerm)}onFormSubmit(e){if(!this.getQuery().length||this.querySelector('[aria-selected="true"] a'))e.preventDefault()}onFormReset(e){super.onFormReset(e);if(super.shouldResetForm()){this.searchTerm="";this.abortController.abort();this.abortController=new AbortController;this.closeResults(true)}}onFocus(){const e=this.getQuery();if(!e.length)return;if(this.searchTerm!==e)this.onChange();else if(this.getAttribute("results")==="true")this.open();else this.getSearchResults(this.searchTerm)}onFocusOut(){setTimeout((()=>{if(!this.contains(document.activeElement))this.close()}))}onKeyup(e){if(!this.getQuery().length)this.close(true);e.preventDefault();switch(e.code){case"ArrowUp":this.switchOption("up");break;case"ArrowDown":this.switchOption("down");break;case"Enter":this.selectOption();break}}onKeydown(e){if(e.code==="ArrowUp"||e.code==="ArrowDown")e.preventDefault()}updateSearchForTerm(e,t){const s=this.querySelector("[data-predictive-search-search-for-text]");const i=s==null?void 0:s.innerText;if(i){if(i.match(new RegExp(e,"g")).length>1)return;const r=i.replace(e,t);s.innerText=r}}switchOption(e){if(!this.getAttribute("open"))return;const t=e==="up";const s=this.querySelector('[aria-selected="true"]');const i=Array.from(this.querySelectorAll("li, button.predictive-search__item")).filter((e=>e.offsetParent!==null));let r=0;if(t&&!s)return;let n=-1;let h=0;while(n===-1&&h<=i.length){if(i[h]===s)n=h;h++}this.statusElement.textContent="";if(!t&&s)r=n===i.length-1?0:n+1;else if(t)r=n===0?i.length-1:n-1;if(r===n)return;const o=i[r];o.setAttribute("aria-selected",true);if(s)s.setAttribute("aria-selected",false);this.input.setAttribute("aria-activedescendant",o.id)}selectOption(){const e=this.querySelector('[aria-selected="true"] a, button[aria-selected="true"]');if(e)e.click()}getSearchResults(e){const t=e.replace(" ","-").toLowerCase();this.setLiveRegionLoadingState();if(this.cachedResults[t]){this.renderSearchResults(this.cachedResults[t]);return}fetch(`${routes.predictive_search_url}?q=${encodeURIComponent(e)}&section_id=predictive-search`,{signal:this.abortController.signal}).then((e=>{if(!e.ok){var t=new Error(e.status);this.close();throw t}return e.text()})).then((e=>{const s=(new DOMParser).parseFromString(e,"text/html").querySelector("#shopify-section-predictive-search").innerHTML;this.allPredictiveSearchInstances.forEach((e=>{e.cachedResults[t]=s}));this.renderSearchResults(s)})).catch((e=>{if((e==null?void 0:e.code)===20)return;this.close();throw e}))}setLiveRegionLoadingState(){this.statusElement=this.statusElement||this.querySelector(".predictive-search-status");this.loadingText=this.loadingText||this.getAttribute("data-loading-text");this.setLiveRegionText(this.loadingText);this.setAttribute("loading",true)}setLiveRegionText(e){this.statusElement.setAttribute("aria-hidden","false");this.statusElement.textContent=e;setTimeout((()=>{this.statusElement.setAttribute("aria-hidden","true")}),1e3)}renderSearchResults(e){this.predictiveSearchResults.innerHTML=e;this.setAttribute("results",true);this.setLiveRegionResults();this.open()}setLiveRegionResults(){this.removeAttribute("loading");this.setLiveRegionText(this.querySelector("[data-predictive-search-live-region-count-value]").textContent)}getResultsMaxHeight(){var e;this.resultsMaxHeight=window.innerHeight-((e=document.querySelector(".section-header"))==null?void 0:e.getBoundingClientRect().bottom);return this.resultsMaxHeight}open(){this.predictiveSearchResults.style.maxHeight=this.resultsMaxHeight||`${this.getResultsMaxHeight()}px`;this.setAttribute("open",true);this.input.setAttribute("aria-expanded",true);this.isOpen=true}close(e=false){this.closeResults(e);this.isOpen=false}closeResults(e=false){if(e){this.input.value="";this.removeAttribute("results")}const t=this.querySelector('[aria-selected="true"]');if(t)t.setAttribute("aria-selected",false);this.input.setAttribute("aria-activedescendant","");this.removeAttribute("loading");this.removeAttribute("open");this.input.setAttribute("aria-expanded",false);this.resultsMaxHeight=false;this.predictiveSearchResults.removeAttribute("style")}}customElements.define("predictive-search",PredictiveSearch);
