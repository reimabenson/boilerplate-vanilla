"use strict";var __defProp=Object.defineProperty;var __defNormalProp=(t,e,i)=>e in t?__defProp(t,e,{enumerable:true,configurable:true,writable:true,value:i}):t[e]=i;var __publicField=(t,e,i)=>__defNormalProp(t,typeof e!=="symbol"?e+"":e,i);if(!customElements.get("product-info"))customElements.define("product-info",class ProductInfo extends HTMLElement{constructor(){super();__publicField(this,"quantityInput");__publicField(this,"quantityForm");__publicField(this,"onVariantChangeUnsubscriber");__publicField(this,"cartUpdateUnsubscriber");__publicField(this,"abortController");__publicField(this,"pendingRequestUrl",null);__publicField(this,"preProcessHtmlCallbacks",[]);__publicField(this,"postProcessHtmlCallbacks",[]);this.quantityInput=this.querySelector(".quantity__input")}connectedCallback(){this.initializeProductSwapUtility();this.onVariantChangeUnsubscriber=subscribe(PUB_SUB_EVENTS.optionValueSelectionChange,this.handleOptionValueChange.bind(this));this.initQuantityHandlers();this.dispatchEvent(new CustomEvent("product-info:loaded",{bubbles:true}))}addPreProcessCallback(t){this.preProcessHtmlCallbacks.push(t)}initQuantityHandlers(){if(!this.quantityInput)return;this.quantityForm=this.querySelector(".product-form__quantity");if(!this.quantityForm)return;this.setQuantityBoundries();if(!this.dataset.originalSection)this.cartUpdateUnsubscriber=subscribe(PUB_SUB_EVENTS.cartUpdate,this.fetchQuantityRules.bind(this))}disconnectedCallback(){var t;this.onVariantChangeUnsubscriber();(t=this.cartUpdateUnsubscriber)==null?void 0:t.call(this)}initializeProductSwapUtility(){this.preProcessHtmlCallbacks.push((t=>t.querySelectorAll(".scroll-trigger").forEach((t=>t.classList.add("scroll-trigger--cancel")))));this.postProcessHtmlCallbacks.push((t=>{var e,i,n;(i=(e=window==null?void 0:window.Shopify)==null?void 0:e.PaymentButton)==null?void 0:i.init();(n=window==null?void 0:window.ProductModel)==null?void 0:n.loadShopifyXR()}))}handleOptionValueChange({data:{event:t,target:e,selectedOptionValues:i}}){if(!this.contains(t.target))return;this.resetProductFormState();const n=e.dataset.productUrl||this.pendingRequestUrl||this.dataset.url;this.pendingRequestUrl=n;const a=this.dataset.url!==n;const r=this.dataset.updateUrl==="true"&&a;this.renderProductInfo({requestUrl:this.buildRequestUrlWithParams(n,i,r),targetId:e.id,callback:a?this.handleSwapProduct(n,r):this.handleUpdateProductInfo(n)})}resetProductFormState(){const t=this.productForm;t==null?void 0:t.toggleSubmitButton(true);t==null?void 0:t.handleErrorMessage()}handleSwapProduct(t,e){return i=>{var n;(n=this.productModal)==null?void 0:n.remove();const a=e?"product-info[id^='MainProduct']":"product-info";const r=this.getSelectedVariant(i.querySelector(a));this.updateURL(t,r==null?void 0:r.id);if(e){document.querySelector("head title").innerHTML=i.querySelector("head title").innerHTML;HTMLUpdateUtility.viewTransition(document.querySelector("main"),i.querySelector("main"),this.preProcessHtmlCallbacks,this.postProcessHtmlCallbacks)}else HTMLUpdateUtility.viewTransition(this,i.querySelector("product-info"),this.preProcessHtmlCallbacks,this.postProcessHtmlCallbacks)}}renderProductInfo({requestUrl:t,targetId:e,callback:i}){var n;(n=this.abortController)==null?void 0:n.abort();this.abortController=new AbortController;fetch(t,{signal:this.abortController.signal}).then((t=>t.text())).then((t=>{this.pendingRequestUrl=null;const e=(new DOMParser).parseFromString(t,"text/html");i(e)})).then((()=>{var t;(t=document.querySelector(`#${e}`))==null?void 0:t.focus()})).catch((t=>{if(t.name==="AbortError")console.log("Fetch aborted by user");else console.error(t)}))}getSelectedVariant(t){var e;const i=(e=t.querySelector("variant-selects [data-selected-variant]"))==null?void 0:e.innerHTML;return!!i?JSON.parse(i):null}buildRequestUrlWithParams(t,e,i=false){const n=[];!i&&n.push(`section_id=${this.sectionId}`);if(e.length)n.push(`option_values=${e.join(",")}`);return`${t}?${n.join("&")}`}updateOptionValues(t){const e=t.querySelector("variant-selects");if(e)HTMLUpdateUtility.viewTransition(this.variantSelectors,e,this.preProcessHtmlCallbacks)}handleUpdateProductInfo(t){return e=>{var i,n,a,r,s,o;const l=this.getSelectedVariant(e);(i=this.pickupAvailability)==null?void 0:i.update(l);this.updateOptionValues(e);this.updateURL(t,l==null?void 0:l.id);this.updateVariantInputs(l==null?void 0:l.id);if(!l){this.setUnavailable();return}this.updateMedia(e,(n=l==null?void 0:l.featured_media)==null?void 0:n.id);const updateSourceFromDestination=(t,i=t=>false)=>{const n=e.getElementById(`${t}-${this.sectionId}`);const a=this.querySelector(`#${t}-${this.dataset.section}`);if(n&&a){a.innerHTML=n.innerHTML;a.classList.toggle("hidden",i(n))}};updateSourceFromDestination("price");updateSourceFromDestination("Sku",(({classList:t})=>t.contains("hidden")));updateSourceFromDestination("Inventory",(({innerText:t})=>t===""));updateSourceFromDestination("Volume");updateSourceFromDestination("Price-Per-Item",(({classList:t})=>t.contains("hidden")));this.updateQuantityRules(this.sectionId,e);(a=this.querySelector(`#Quantity-Rules-${this.dataset.section}`))==null?void 0:a.classList.remove("hidden");(r=this.querySelector(`#Volume-Note-${this.dataset.section}`))==null?void 0:r.classList.remove("hidden");(o=this.productForm)==null?void 0:o.toggleSubmitButton(((s=e.getElementById(`ProductSubmitButton-${this.sectionId}`))==null?void 0:s.hasAttribute("disabled"))??true,window.variantStrings.soldOut);publish(PUB_SUB_EVENTS.variantChange,{data:{sectionId:this.sectionId,html:e,variant:l}})}}updateVariantInputs(t){this.querySelectorAll(`#product-form-${this.dataset.section}, #product-form-installment-${this.dataset.section}`).forEach((e=>{const i=e.querySelector('input[name="id"]');i.value=t??"";i.dispatchEvent(new Event("change",{bubbles:true}))}))}updateURL(t,e){var i;(i=this.querySelector("share-button"))==null?void 0:i.updateUrl(`${window.shopUrl}${t}${e?`?variant=${e}`:""}`);if(this.dataset.updateUrl==="false")return;window.history.replaceState({},"",`${t}${e?`?variant=${e}`:""}`)}setUnavailable(){var t;(t=this.productForm)==null?void 0:t.toggleSubmitButton(true,window.variantStrings.unavailable);const e=["price","Inventory","Sku","Price-Per-Item","Volume-Note","Volume","Quantity-Rules"].map((t=>`#${t}-${this.dataset.section}`)).join(", ");document.querySelectorAll(e).forEach((({classList:t})=>t.add("hidden")))}updateMedia(t,e){var i,n,a;if(!e)return;const r=this.querySelector("media-gallery ul");const s=t.querySelector(`media-gallery ul`);const refreshSourceData=()=>{if(this.hasAttribute("data-zoom-on-hover"))enableZoomOnHover(2);const t=Array.from(r.querySelectorAll("li[data-media-id]"));const e=new Set(t.map((t=>t.dataset.mediaId)));const i=new Map(t.map(((t,e)=>[t.dataset.mediaId,{item:t,index:e}])));return[t,e,i]};if(r&&s){let[t,e,i]=refreshSourceData();const n=Array.from(s.querySelectorAll("li[data-media-id]"));const a=new Set(n.map((({dataset:t})=>t.mediaId)));let o=false;for(let s=n.length-1;s>=0;s--)if(!e.has(n[s].dataset.mediaId)){r.prepend(n[s]);o=true}for(let r=0;r<t.length;r++)if(!a.has(t[r].dataset.mediaId)){t[r].remove();o=true}if(o)[t,e,i]=refreshSourceData();n.forEach(((n,a)=>{const s=i.get(n.dataset.mediaId);if(s&&s.index!==a){r.insertBefore(s.item,r.querySelector(`li:nth-of-type(${a+1})`));[t,e,i]=refreshSourceData()}}))}(n=(i=this.querySelector(`media-gallery`))==null?void 0:i.setActiveMedia)==null?void 0:n.call(i,`${this.dataset.section}-${e}`,true);const o=(a=this.productModal)==null?void 0:a.querySelector(`.product-media-modal__content`);const l=t.querySelector(`product-modal .product-media-modal__content`);if(o&&l)o.innerHTML=l.innerHTML}setQuantityBoundries(){const t={cartQuantity:this.quantityInput.dataset.cartQuantity?parseInt(this.quantityInput.dataset.cartQuantity):0,min:this.quantityInput.dataset.min?parseInt(this.quantityInput.dataset.min):1,max:this.quantityInput.dataset.max?parseInt(this.quantityInput.dataset.max):null,step:this.quantityInput.step?parseInt(this.quantityInput.step):1};let e=t.min;const i=t.max===null?t.max:t.max-t.cartQuantity;if(i!==null)e=Math.min(e,i);if(t.cartQuantity>=t.min)e=Math.min(e,t.step);this.quantityInput.min=e;if(i)this.quantityInput.max=i;else this.quantityInput.removeAttribute("max");this.quantityInput.value=e;publish(PUB_SUB_EVENTS.quantityUpdate,void 0)}fetchQuantityRules(){var t,e;const i=(e=(t=this.productForm)==null?void 0:t.variantIdInput)==null?void 0:e.value;if(!i)return;this.querySelector(".quantity__rules-cart .loading__spinner").classList.remove("hidden");return fetch(`${this.dataset.url}?variant=${i}&section_id=${this.dataset.section}`).then((t=>t.text())).then((t=>{const e=(new DOMParser).parseFromString(t,"text/html");this.updateQuantityRules(this.dataset.section,e)})).catch((t=>console.error(t))).finally((()=>this.querySelector(".quantity__rules-cart .loading__spinner").classList.add("hidden")))}updateQuantityRules(t,e){if(!this.quantityInput)return;this.setQuantityBoundries();const i=e.getElementById(`Quantity-Form-${t}`);const n=[".quantity__input",".quantity__rules",".quantity__label"];for(let a of n){const t=this.quantityForm.querySelector(a);const e=i.querySelector(a);if(!t||!e)continue;if(a===".quantity__input"){const i=["data-cart-quantity","data-min","data-max","step"];for(let n of i){const i=e.getAttribute(n);if(i!==null)t.setAttribute(n,i);else t.removeAttribute(n)}}else t.innerHTML=e.innerHTML}}get productForm(){return this.querySelector(`product-form`)}get productModal(){return document.querySelector(`#ProductModal-${this.dataset.section}`)}get pickupAvailability(){return this.querySelector(`pickup-availability`)}get variantSelectors(){return this.querySelector("variant-selects")}get relatedProducts(){const t=SectionId.getIdForSection(SectionId.parseId(this.sectionId),"related-products");return document.querySelector(`product-recommendations[data-section-id^="${t}"]`)}get quickOrderList(){const t=SectionId.getIdForSection(SectionId.parseId(this.sectionId),"quick_order_list");return document.querySelector(`quick-order-list[data-id^="${t}"]`)}get sectionId(){return this.dataset.originalSection||this.dataset.section}});
