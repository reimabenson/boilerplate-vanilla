"use strict";if(!customElements.get("product-form"))customElements.define("product-form",class ProductForm extends HTMLElement{constructor(){super();this.form=this.querySelector("form");this.variantIdInput.disabled=false;this.form.addEventListener("submit",this.onSubmitHandler.bind(this));this.cart=document.querySelector("cart-notification")||document.querySelector("cart-drawer");this.submitButton=this.querySelector('[type="submit"]');this.submitButtonText=this.submitButton.querySelector("span");if(document.querySelector("cart-drawer"))this.submitButton.setAttribute("aria-haspopup","dialog");this.hideErrors=this.dataset.hideErrors==="true"}onSubmitHandler(t){t.preventDefault();if(this.submitButton.getAttribute("aria-disabled")==="true")return;this.handleErrorMessage();this.submitButton.setAttribute("aria-disabled",true);this.submitButton.classList.add("loading");this.querySelector(".loading__spinner").classList.remove("hidden");const e=fetchConfig("javascript");e.headers["X-Requested-With"]="XMLHttpRequest";delete e.headers["Content-Type"];const r=new FormData(this.form);if(this.cart){r.append("sections",this.cart.getSectionsToRender().map((t=>t.id)));r.append("sections_url",window.location.pathname);this.cart.setActiveElement(document.activeElement)}e.body=r;fetch(`${routes.cart_add_url}`,e).then((t=>t.json())).then((t=>{if(t.status){publish(PUB_SUB_EVENTS.cartError,{source:"product-form",productVariantId:r.get("id"),errors:t.errors||t.description,message:t.message});this.handleErrorMessage(t.description);const e=this.submitButton.querySelector(".sold-out-message");if(!e)return;this.submitButton.setAttribute("aria-disabled",true);this.submitButtonText.classList.add("hidden");e.classList.remove("hidden");this.error=true;return}else if(!this.cart){window.location=window.routes.cart_url;return}const e=CartPerformance.createStartingMarker("add:wait-for-subscribers");if(!this.error)publish(PUB_SUB_EVENTS.cartUpdate,{source:"product-form",productVariantId:r.get("id"),cartData:t}).then((()=>{CartPerformance.measureFromMarker("add:wait-for-subscribers",e)}));this.error=false;const s=this.closest("quick-add-modal");if(s){document.body.addEventListener("modalClosed",(()=>{setTimeout((()=>{CartPerformance.measure("add:paint-updated-sections",(()=>{this.cart.renderContents(t)}))}))}),{once:true});s.hide(true)}else CartPerformance.measure("add:paint-updated-sections",(()=>{this.cart.renderContents(t)}))})).catch((t=>{console.error(t)})).finally((()=>{this.submitButton.classList.remove("loading");if(this.cart&&this.cart.classList.contains("is-empty"))this.cart.classList.remove("is-empty");if(!this.error)this.submitButton.removeAttribute("aria-disabled");this.querySelector(".loading__spinner").classList.add("hidden");CartPerformance.measureFromEvent("add:user-action",t)}))}handleErrorMessage(t=false){if(this.hideErrors)return;this.errorMessageWrapper=this.errorMessageWrapper||this.querySelector(".product-form__error-message-wrapper");if(!this.errorMessageWrapper)return;this.errorMessage=this.errorMessage||this.errorMessageWrapper.querySelector(".product-form__error-message");this.errorMessageWrapper.toggleAttribute("hidden",!t);if(t)this.errorMessage.textContent=t}toggleSubmitButton(t=true,e){if(t){this.submitButton.setAttribute("disabled","disabled");if(e)this.submitButtonText.textContent=e}else{this.submitButton.removeAttribute("disabled");this.submitButtonText.textContent=window.variantStrings.addToCart}}get variantIdInput(){return this.form.querySelector("[name=id]")}});
